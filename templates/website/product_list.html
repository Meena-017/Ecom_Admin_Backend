{% extends "website/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<h2 class="mb-4">Products</h2>

<!-- Add / Edit Product Form -->
<div class="card mb-4">
  <div class="card-header">Add / Edit Product</div>
  <div class="card-body">
    <form method="POST" id="productForm" action="{% url 'frontend_product_list' %}">
      {% csrf_token %}
      <input type="hidden" name="product_id" id="product_id" value="">
      <div class="row g-2">
        <div class="col-md-3">
          <input class="form-control" name="name" id="name" placeholder="Name" required>
        </div>
        <div class="col-md-4">
          <input class="form-control" name="description" id="description" placeholder="Description" required>
        </div>
        <div class="col-md-2">
          <input class="form-control" name="price" id="price" placeholder="Price" type="number" step="0.01" required>
        </div>
        <div class="col-md-2">
          <input class="form-control" name="stock" id="stock" placeholder="Stock" type="number" required>
        </div>
        <div class="col-md-1">
          <button class="btn btn-success w-100" type="submit" name="add_product" id="addBtn">Add</button>
          <button class="btn btn-primary w-100 d-none" type="submit" name="edit_product" id="editBtn">Update</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Product Cards -->
<div class="row row-cols-1 row-cols-md-3 g-4">
  {% for product in products %}
  <div class="col">
    <div class="card h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title">{{ product.name }}</h5>
        <p class="card-text mb-2">{{ product.description|truncatechars:120 }}</p>
        <p class="mb-2"><strong>Price:</strong> ₹{{ product.price }} &nbsp; <strong>Stock:</strong> {{ product.stock }}</p>

        <div class="mt-auto">
          <!-- View Modal Button -->
          <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewModal{{ product.id }}">View</button>

          <!-- Add to Cart -->
          <form method="POST" action="{% url 'add_to_cart' product.id %}" style="display:inline;">
            {% csrf_token %}
            <button class="btn btn-success btn-sm">Add to Cart</button>
          </form>

          <!-- Edit -->
          <button
            class="btn btn-warning btn-sm edit-btn"
            type="button"
            data-id="{{ product.id }}"
            data-name="{{ product.name|escape }}"
            data-description="{{ product.description|escape }}"
            data-price="{{ product.price }}"
            data-stock="{{ product.stock }}"
          >Edit</button>

          <!-- Delete -->
          <form method="POST" action="{% url 'frontend_product_list' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <button type="submit" name="delete_product" class="btn btn-danger btn-sm" onclick="return confirm('Delete this product?');">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Product View Modal -->
  <div class="modal fade" id="viewModal{{ product.id }}" tabindex="-1" aria-labelledby="viewModalLabel{{ product.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewModalLabel{{ product.id }}">{{ product.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>{{ product.description }}</p>
          <p><strong>Price:</strong> ₹{{ product.price }}</p>
          <p><strong>Stock:</strong> {{ product.stock }}</p>
        </div>
        <div class="modal-footer">
          <form method="POST" action="{% url 'add_to_cart' product.id %}">
            {% csrf_token %}
            <button class="btn btn-success">Add to Cart</button>
          </form>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.edit-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      document.getElementById('product_id').value = this.dataset.id;
      document.getElementById('name').value = this.dataset.name;
      document.getElementById('description').value = this.dataset.description;
      document.getElementById('price').value = this.dataset.price;
      document.getElementById('stock').value = this.dataset.stock;

      document.getElementById('addBtn').classList.add('d-none');
      document.getElementById('editBtn').classList.remove('d-none');
      document.getElementById('productForm').scrollIntoView({behavior: 'smooth', block: 'center'});
    });
  });
});
</script>
{% endblock %}
